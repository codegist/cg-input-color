<link href="../polymer/polymer.html" rel="import">
<link rel="import" href="../iron-validatable-behavior/iron-validatable-behavior.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link href="../cg-base/cg-base-behavior.html" rel="import">
<link href="../paper-material/paper-material.html" rel="import">
<link href="cg-input-color-validator.html" rel="import">

<dom-module is="cg-input-color">
<style>
    .color-wrapper .color {
        @apply(--layout-relative);
        width:20px;
        height:20px;
        margin-right:5px;
        cursor:pointer;
        outline:0;
    }
    .color-wrapper .dot {
        @apply(--layout-fit);
        border-radius:100%;
    }
    .color-wrapper {
        @apply(--layout-horizontal);
        @apply(--layout-wrap);
        padding-bottom:10px;
    }
</style>
<template>
    <cg-input-color-validator required="[[required]]"></cg-input-color-validator>
    <div class="color-wrapper">
        <template is="dom-repeat" items="{{colors}}" as="c">
            <div class="color"
                 tabindex="0"
                 title$="{{c.name}}"
                 data-value$="{{c.mask}}"
                 on-tap="_selectColor"
                 on-focus="_selectColor">
                <paper-material class="dot" animated style$="[[computeStyle(c)]]"></paper-material>
            </div>
        </template>
    </div>
</template>
</dom-module>
<script>
Polymer({
    is:"cg-input-color",
    properties:{
        listensTo:{
            value:[]
        },
        cgName:{
            value:"colors"
        },
        label:String,
        required:{
            type:Boolean,
            value:false
        },
        colors:{
            type:Array,
            value:null
        },
        selected:{
            type:Object,
            value:null,
            observer:"selectedChanged",
            notify:true
        },
        validator: {
            type: String,
            value: 'cg-input-color-validator'
        }
    },
    behaviors:[CG.BaseBehavior, Polymer.IronValidatableBehavior],
    _decoratorElement:null,
    ready:function(){
        if(this.isDataAware() && this.colors == null) {
            console.log("[cg-input-color] no colors provided firing data request");
            this.fireDataRequest({
                type:"data",
                success:function(response){
                    this.colors = response.data;
                    this.async(this.selectedChanged, 10)
                }.bind(this),
                failure:function(response){}.bind(this)
            });
        }else{
            console.log("[cg-input-color] colors provided, using them");
            this.selectedChanged();
        }
    },
    computeStyle:function(c){
        return c ? "background-color:" + c.mask : "";
    },
    selectedChanged:function(){
        Array.prototype.forEach.call(Polymer.dom(this.root).querySelectorAll(".color"), function(color){
            color.querySelector(".dot").elevation = (this.selected && color.dataset.value == this.selected.mask ? 3 : 0);
        }.bind(this));
        this.fire('change', this.selected);
    },
    _selectColor:function(e){
        this.selected = this._getColorByMask(e.currentTarget.dataset.value);
    },
    _getColorByMask:function(mask){
        for(var i =0; i< this.colors.length;i++){
            if(this.colors[i].mask == mask) {
                return this.colors[i];
            }
        }
        return null;
    }
});
</script>